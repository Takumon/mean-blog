<div class="article-area" *ngIf="article">
  <h1 class="article-title">{{article.title}}</h1>
  <div class="article-metadata">
    <img class="article-author-icon" src="data:image/png;base64,{{article.author.icon}}">
    <div class="article-author">{{article.author.userId}}</div>
    <div class="article-date">{{article.date | date: 'yyyy/MM/dd HH:mm' }}</div>
    <div *ngIf="auth.loginUser.userId === article.author.userId" class="operation-area">
      <button md-button [routerLink]="['/drafts', article.articleId, 'edit']"  routerLinkActive="active">
        <i class="fa fa-fw fa-pencil-square"></i><span>  編集</span>
      </button>
      <span class="spacer"></span>
      <button md-button [mdMenuTriggerFor]="menu">
        <i class="fa fa-fw fa-cog"></i>  設定
      </button>
      <md-menu #menu="mdMenu">
        <div md-menu-item disabled></div>
        <a md-menu-item (click)="deleteArticle()">
          <i class="fa fa-fw fa-trash-o"></i><span>  削除</span>
        </a>
      </md-menu>
    </div>
  </div>
  <div class="article-body">
    <div *ngIf="article.isMarkdown; then markdown else plainText"></div>
    <ng-template #markdown>
      <p [innerHTML]="article.body | toMarkdown" class="markdown-body"></p>
    </ng-template>
    <ng-template #plainText>
      <pre [innerHTML]="article.body" class="plain-text-body"></pre>                
    </ng-template>
  </div>
</div>

<div class="article-comment-area">
  <div *ngIf="comments && article" class="article-comment-area-title" >{{comments.length}}件のコメント</div>
  <ng-container *ngIf="comments && article">
    <div
      *ngFor="let comment of comments; let last = last"
      class="article-comment"
      [class.last-item]="last"
      [style.marginLeft.px]="calcMarginOfComment(comment.depth)" 
      >

      <div *ngIf="comment.isEditable; then editComment else displayComment"></div>
      <ng-template #editComment>
        <app-comment-form 
          [commentModel]="commentOfForm(comment)"
          [hasCancelBtn]="true"
          [isAuthfocuse]="true"
          (complete)="refreshComments()"
          (cancel)="comment.isEditable = false;"
          ></app-comment-form>
      </ng-template>
      <ng-template #displayComment>
        <div class="article-comment-display-container">
          <img class="article-comment-author-icon" src="data:image/png;base64,{{comment.user.icon}}">
          <div class="article-comment-content">
            <div class="article-comment-metadata">
              <div class="article-comment-author">{{comment.user.userId}}</div>
              <div class="article-comment-created">{{comment.updated | date: 'yyyy/MM/dd HH:mm' }}</div>
            </div>
            <div class="article-comment-text">
              <pre [innerHTML]="comment.text" class="article-comment-plain-text-body"></pre>                
            </div>
            <div class="comment-operation-area">
              <button
                md-button
                (click)="comment.addReply = true; comment.isEditable = false;">
                <i class="fa fa-fw fa-reply"></i><span>  返信</span>
              </button>
              <button 
                md-button 
                *ngIf="auth.loginUser._id === comment.user._id"
                (click)="comment.isEditable = true; comment.addReply = false">
                <i class="fa fa-fw fa-pencil-square"></i><span>  編集</span>
              </button>
              <button
                md-button
                *ngIf="auth.loginUser._id === comment.user._id"
                (click)="deleteComment(comment._id)">
                <i class="fa fa-fw fa-trash-o"></i><span>  削除</span>
              </button>
            </div>
          </div>
        </div>
        <div *ngIf="comment.addReply" class="add-reply-area">
          <app-comment-form  
            [commentModel]="commentOfForm(null, comment._id)"
            [hasCancelBtn]="true"
            [isAuthfocuse]="true"
            (complete)="refreshComments()"
            (cancel)="comment.addReply = false;"
            ></app-comment-form>
        </div>
      </ng-template>
    </div>
  </ng-container>
  <div *ngIf="auth.loginUser && article" class="article-comment-register">
    <app-comment-form 
      [commentModel]="commentOfForm()"
      [hasCancelBtn]="false"
      [isAuthfocuse]="false"
      (complete)="refreshComments()"></app-comment-form>
  </div>
</div>
