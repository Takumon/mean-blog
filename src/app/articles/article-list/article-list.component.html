<app-search-condition
  *ngIf="mode && mode === Modes.FAVORITE"
  (changeSeaerchCondition)="getArticles()"
  ></app-search-condition>
<div class="message-area" *ngIf="(articles && articles.length === 0) && (!seaerchConditions || seaerchConditions.length < 1)">
  <div class="message-area__main">
    <div class="message-area__main__icon">
      <i class="fa fa-fw fa-2x fa-exclamation-triangle"></i>
    </div>
    <div class="message-area__main__message">
      記事がまだ登録されていません。記事を登録しましよう。
    </div>
  </div>
  <div class="message-area__operation">
    <div class="message-area__operation__spacer"></div>
    <button
      md-raised-button
      color="primary"
      routerLink="/drafts/new">
        <i class="fa fa-fw fa-pencil fa-2x"></i> 記事を投稿する
    </button>
  </div>
</div>

<div class="message-area" *ngIf="(articles && articles.length === 0) && !(!seaerchConditions || seaerchConditions.length < 1)">
  <div class="message-area__main">
    <div class="message-area__main__icon">
      <i class="fa fa-fw fa-2x fa-exclamation-triangle"></i>
    </div>
    <div class="message-area__main__message">
      検索結果に一致する記事は見つかりませんでした。検索条件を変えて再度検索してください。
    </div>
  </div>
</div>
<div class="prograss-bar" *ngIf="showPrograssBar" >
  <md-spinner></md-spinner>
</div>
<ng-container *ngIf="articles && articles.length > 0">
  <div class="article-list" *ngIf="!showPrograssBar">
    <div
      class="article-list__item article"
      *ngFor="let item of articles | orderby: ['-created']">
      <div class="article__header"
        [routerLink]="['/', item.author.userId, 'articles', item._id]"
        routerLinkActive="active">
        <div class="article__avator">
          <img class="article__avator-icon" src="data:image/png;base64,{{item.author.icon}}">
        </div>
        <div class="article__subtitle">
          <div class="article__author-name">{{item.author.userId}}</div>
          <div class="article__date">{{item.updated | date: 'yyyy/MM/dd HH:mm' }}<span class="article__created-or-updated"> に{{item.created == item.updated ? "投稿" : "更新" }}</span></div>
        </div>
        <div class="article__title-wrapper">
          <div  class="article__title">{{item.title}}</div>
        </div>
      </div>
      <div class="article__main">
        <div *ngIf="item.isMarkdown; then markdown else plainText"></div>
        <ng-template #markdown>
          <p [innerHTML]="(item.body | toMarkdown).text" class="markdown-body"></p>
        </ng-template>
        <ng-template #plainText>
          <pre [innerHTML]="item.body" class="plain-text-body"></pre>                
        </ng-template>
      </div>

      <div class="article__operation">
        <button 
          md-button
          type="button"
          class="article__operation-btn"
          (click)="registerVote(item)"
          *ngIf="!containMineVote(item.vote)"
          >
          <i class="fa fa-fw fa-thumbs-up"></i> いいね!
        </button>
        <button 
          md-button
          type="button"
          class="article__operation-btn"
          (click)="deleteVote(item)"
          *ngIf="containMineVote(item.vote)"
          >
          <i class="fa fa-fw fa-check"></i> いいね済み
        </button>
        <button 
          md-button
          type="button"
          class="article__operation-btn"
          (click)="createNewComment(item)"
          >
          <i class="fa fa-fw fa-commenting"></i>コメントする
        </button>
      </div>
      
      <ng-container *ngIf="item.showCommentDetail; then displayCommentDetail else displayComment"></ng-container>
      
      <ng-template #displayComment>
        <div *ngIf="(item.comments && (item.comments | excludeDeletedComment).length > 0) || (item.vote && item.vote.length > 0)" class="article__comments comments">
          <div
            *ngIf="!item.vote || item.vote.length < 1"
            class="comments__count_vote">
            <i class="comments__count-icon fa fa-fw fa-thumbs-up"></i>0<span class="comments__count-unit">人</span>
          </div>
          
          <div
            *ngIf="item.vote && item.vote.length > 0"
            class="comments__count_vote_link"
            (click)="openVotersList(item.vote)">
            <i class="comments__count-icon fa fa-fw fa-thumbs-up"></i>{{item.vote.length}}<span class="comments__count-unit">人</span>
          </div>
          
          <div class="comments__count">
            <i class="comments__count-icon fa fa-fw fa-commenting"></i>{{(item.comments | excludeDeletedComment).length}}<span class="comments__count-unit">件</span>
          </div>
          <div class="comments__main">
            <div 
              *ngFor="let comment of (item.comments | excludeDeletedComment)"
              class="comments__comment"
              >
                <img
                  *ngIf="!comment.userDeleted && !comment.deleted"
                  mdTooltip="【{{comment.user.userId}}】&#013;{{comment.text}}"
                  class="comments__comment__user"
                  src="data:image/png;base64,{{comment.user.icon}}">
            </div>
          </div>

          <div class="comments__operation">
            <div class="comments__operation__spacer"></div>
            <button
              *ngIf="item.comments && (item.comments | excludeDeletedComment).length > 0"
              md-icon-button
              mdTooltip="コメント詳細を開く"
              mdTooltipPosition="above"
              mdTooltipShowDelay="500"
              type="button"
              class="comments__operation__show-detail-btn"
              (click)="toggleCommentDetail(item)"><i class="fa fa-fw fa-chevron-down"></i></button>
          </div>
        </div>
        <div *ngIf="item.newComment" class="article__comment-editor comment-editor">
          <img class="comment-editor__author-icon" *ngIf="auth.loginUser" src="data:image/png;base64,{{auth.loginUser.icon }}">
          <textarea
            class="comment-editor__body"
            appAutofocus
            [(ngModel)]="item.newComment.text"
            placeholder="コメントする..." ></textarea>
          <button 
            md-raised-button
            type="button"
            class="comment-editor__cancel-btn"
            (click)="cancelNewComment(item)"><i class="fa fa-fw fa-times"></i>  キャンセル</button>

          <button
            md-raised-button
            class="comment-editor__register-btn"
            color="primary"
            type="button"
            id="registe-comment-btn"
            (click)="registerComment(item, item.newComment)"><i class="fa fa-fw fa-commenting"></i>  追加</button>
        </div>
      </ng-template>

      <ng-template #displayCommentDetail>
        <div class="article__comments-detail">
          <app-comment-list
            [hasCloseBtn]="true"
            _idOfArticle="{{item._id}}"
            [comments]="item.comments"
            (refresh)="refreshComments(item, $event)"
            (close)="toggleCommentDetail(item)"
          ></app-comment-list>
        </div>
      </ng-template>
    </div>
  </div>
</ng-container>
