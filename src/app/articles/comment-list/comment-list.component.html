<ng-container *ngIf="!comments">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</ng-container>
<ng-container *ngIf="comments">
  <div class="comment-list-header">
    <div class="comment-list-header__count" >コメント{{(comments | excludeDeletedComment).length}}件</div>
    <div class="comment-list-header__spacer"></div>
  </div>
  <div
    *ngFor="let comment of (comments | excludeDeletedLeafComment)"
    class="comment-list-content"
    [style.marginLeft.px]="calcMarginOfComment(comment.depth)"
    >

    <div *ngIf=" comment.userDeleted;                                            then displayDeletedUserComment"></div>
    <div *ngIf="!comment.userDeleted &&  comment.deleted;                        then displayDeletedComment"></div>
    <div *ngIf="!comment.userDeleted && !comment.deleted && comment.isEditable;  then editComment"></div>
    <div *ngIf="!comment.userDeleted && !comment.deleted && !comment.isEditable; then displayComment"></div>
    <ng-template #displayDeletedUserComment>
      <div class="comment_deleted">
        <img class="comment__author-icon" src="assets/images/deleted-comment.png">
        <div class="comment__main">
          <pre class="comment__text_deleted">このコメントの投稿者は削除されました。</pre>
        </div>
      </div>
    </ng-template>
    <ng-template #displayDeletedComment>
      <div class="comment_deleted">
        <img class="comment__author-icon" src="assets/images/deleted-comment.png">
        <div class="comment__main">
          <pre class="comment__text_deleted">このコメントは削除されました。</pre>
        </div>
      </div>
    </ng-template>
    <ng-template #editComment>
      <app-comment-form
        [commentModel]="commentOfForm(comment)"
        [hasCancelBtn]="true"
        [isAuthfocuse]="true"
        (complete)="refreshComments()"
        (cancel)="comment.isEditable = false;"
        ></app-comment-form>
    </ng-template>
    <ng-template #displayComment>
      <div class="comment">
        <img
          class="comment__author-icon"
          src="data:image/png;base64,{{comment.user.icon}}"
          [routerLink]="['/', comment.user.userId, 'articles']"
          >
        <div class="comment__main">
          <div class="comment__metadata">
            <div
              class="comment__author"
              [routerLink]="['/', comment.user.userId, 'articles']"
              >{{comment.user.userId}}</div>
            <div class="comment__created">{{comment.updated | date: 'yyyy/MM/dd HH:mm' }}<span> に{{comment.created == comment.updated ? "投稿" : "更新" }}</span></div>
          </div>
          <pre [innerHTML]="comment.text" class="comment__text"></pre>
          <div class="comment__operation">
            <button
              mat-button
              (click)="comment.addReply = true; comment.isEditable = false;">
              <i class="fa fa-fw fa-reply"></i><span>  返信</span>
            </button>
            <button
              mat-button
              *ngIf="auth.loginUser._id === comment.user._id"
              (click)="comment.isEditable = true; comment.addReply = false">
              <i class="fa fa-fw fa-pencil-square"></i><span>  編集</span>
            </button>
            <button
              mat-button
              *ngIf="auth.loginUser._id === comment.user._id"
              (click)="deleteComment(comment._id)">
              <i class="fa fa-fw fa-trash-o"></i><span>  削除</span>
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="comment.addReply" class="reply">
        <app-comment-form
          [commentModel]="commentOfForm(null, comment._id)"
          [hasCancelBtn]="true"
          [isAuthfocuse]="true"
          (complete)="refreshComments()"
          (cancel)="comment.addReply = false;"
          ></app-comment-form>
      </div>
    </ng-template>
  </div>
  <div *ngIf="auth.loginUser">
      <app-comment-form
        [commentModel]="commentOfForm()"
        [hasCancelBtn]="false"
        [isAuthfocuse]="false"
        (complete)="refreshComments()"></app-comment-form>
  </div>
</ng-container>